<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Localisation PK - Mobile Friendly</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
  body {
    margin: 0; padding: 0;
    font-family: 'Roboto', sans-serif;
    background-color: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  header {
    background-color: #003399;
    color: white;
    padding: 12px 20px;
    font-weight: 700;
    font-size: 1.6rem;
    text-align: center;
    user-select: none;
  }
  main {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 0 15px;
    text-align: center;
  }
  #pk-value {
    font-size: 7rem;
    font-weight: 900;
    color: #99ff99;
    user-select: none;
    margin-bottom: 0.3em;
    line-height: 1;
  }
  #pk-label {
    font-size: 1.2rem;
    opacity: 0.7;
    margin-bottom: 1.5rem;
    user-select: none;
  }
  #coords, #speed {
    font-size: 1.1rem;
    margin: 6px 0;
    user-select: none;
  }
  #speed.light-mode {
    color: #003399;
  }
  footer {
    padding: 10px 20px;
    background-color: #222;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  button {
    background-color: #003399;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 14px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    min-width: 48px;
    min-height: 48px;
    flex-grow: 1;
    max-width: 200px;
  }
  button:hover {
    background-color: #0055cc;
  }
  /* Light mode */
  body.light-mode {
    background-color: #f0f4ff;
    color: #222;
  }
  body.light-mode header {
    background-color: #99bbff;
    color: #111;
  }
  body.light-mode footer {
    background-color: #c0d4ff;
  }
  body.light-mode button {
    background-color: #003399;
    color: white;
  }
  /* Responsive */
  @media (max-width: 480px) {
    #pk-value {
      font-size: 5rem;
    }
    button {
      max-width: 100%;
      padding: 12px 0;
      font-size: 1rem;
    }
  }
</style>
</head>
<body>
  <header>Localisation PK SNCF</header>
  <main>
    <div id="pk-value">--.--</div>
    <div id="pk-label">PK approximatif</div>
    <div id="coords">Position : --</div>
    <div id="speed" class="">Vitesse : inconnue</div>
  </main>
  <footer>
    <button id="refresh" aria-label="RafraÃ®chir position">ðŸ”„ RafraÃ®chir position</button>
    <button id="modeToggle" aria-label="Changer mode jour nuit">ðŸŒ™ Mode Jour / Nuit</button>
  </footer>

<script src="zones.js"></script>
<script>
  let currentZoneCode = null;
  let pkScript = null;
  let latestPosition = null;

  function getCurrentZone(lat, lon) {
    for (const zone of zones) {
      if (
        lat >= zone.latMin && lat <= zone.latMax &&
        lon >= zone.lonMin && lon <= zone.lonMax
      ) {
        return zone.code_ligne;
      }
    }
    return null;
  }

  function updatePosition(lat, lon) {
    latestPosition = { lat, lon };
    const zoneCode = getCurrentZone(lat, lon);
    if (!zoneCode) {
      document.getElementById("pk-value").textContent = "--.--";
      return;
    }

    if (zoneCode !== currentZoneCode) {
      currentZoneCode = zoneCode;
      if (pkScript) pkScript.remove();

      pkScript = document.createElement("script");
      pkScript.src = `pks_${zoneCode}.js`;
      pkScript.onload = () => {
        showPK(lat, lon);
      };
      document.head.appendChild(pkScript);
    } else if (typeof pkData !== "undefined") {
      showPK(lat, lon);
    }
  }

  function showPK(lat, lon) {
    if (!pkData) {
      document.getElementById("pk-value").textContent = "--.--";
      return;
    }
    const nearest = findNearestPK(lat, lon);
    document.getElementById("pk-value").textContent = nearest.pk.toFixed(2);
  }

  function findNearestPK(lat, lon) {
    let minDist = Infinity;
    let nearest = null;
    for (const point of pkData) {
      const d = Math.hypot(point.lat - lat, point.lon - lon);
      if (d < minDist) {
        minDist = d;
        nearest = point;
      }
    }
    return nearest;
  }

  function updateSpeed(speed) {
    const speedDisplay = document.getElementById("speed");
    if (speed !== null && !isNaN(speed)) {
      const kmh = (speed * 3.6).toFixed(1);
      speedDisplay.textContent = `Vitesse : ${kmh} km/h`;
      if (document.body.classList.contains("light-mode")) {
        speedDisplay.classList.add("light-mode");
      } else {
        speedDisplay.classList.remove("light-mode");
      }
    } else {
      speedDisplay.textContent = "Vitesse : inconnue";
      speedDisplay.classList.remove("light-mode");
    }
  }

  function updateCoords(lat, lon) {
    document.getElementById("coords").textContent = `Position : ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
  }

  function watchPosition() {
    if (!navigator.geolocation) {
      document.getElementById("coords").textContent = "GÃ©olocalisation non supportÃ©e";
      return;
    }
    navigator.geolocation.watchPosition(
      pos => {
        const { latitude, longitude, speed } = pos.coords;
        latestPosition = { lat: latitude, lon: longitude };
        updateCoords(latitude, longitude);
        updateSpeed(speed);
        updatePosition(latitude, longitude);
      },
      err => {
        document.getElementById("coords").textContent = "Erreur gÃ©olocalisation : " + err.message;
      },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
    );
  }

  document.getElementById("refresh").addEventListener("click", () => {
    if (latestPosition) {
      updatePosition(latestPosition.lat, latestPosition.lon);
    }
  });

  document.getElementById("modeToggle").addEventListener("click", () => {
    document.body.classList.toggle("light-mode");
    // change label icon/text
    const btn = document.getElementById("modeToggle");
    if (document.body.classList.contains("light-mode")) {
      btn.textContent = "ðŸŒž Mode Nuit";
    } else {
      btn.textContent = "ðŸŒ™ Mode Jour";
    }
    // update speed color immediately
    const speedDisplay = document.getElementById("speed");
    if (speedDisplay.textContent.includes("Vitesse : inconnue")) return;
    if (document.body.classList.contains("light-mode")) {
      speedDisplay.classList.add("light-mode");
    } else {
      speedDisplay.classList.remove("light-mode");
    }
  });

  window.onload = () => {
    watchPosition();
  };
</script>
</body>
</html>